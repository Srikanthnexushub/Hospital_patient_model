# Implementation Plan: Clinical Intelligence & Safety Module

**Branch**: `006-clinical-intelligence` | **Date**: 2026-02-21 | **Spec**: [spec.md](spec.md)

---

## Summary

Module 6 adds a proactive clinical intelligence layer on top of the frozen Modules 1–5 stack. It introduces three new persisted entities (`LabOrder`, `LabResult`, `ClinicalAlert`) via Flyway V22–V24, one static in-memory drug interaction database (`DrugInteractionDatabase @Component` with 40+ curated drug pairs), and a pure-Java NEWS2 Early Warning Score calculator. All existing entities and migrations are read-only. The module provides 13 new REST endpoints across 5 user stories: lab order/result management with auto-alerting, NEWS2 score computation, drug interaction/allergy checking, a unified clinical alerts feed, and a risk-ranked patient dashboard.

---

## Technical Context

**Language/Version**: Java 17 (LTS), Spring Boot 3.2.x
**Primary Dependencies**: Spring Data JPA (Hibernate 6), Spring Security, Lombok, MapStruct, Resilience4j, Micrometer, Flyway 10.x, jjwt 0.12.5
**New Dependencies**: None — all required libraries already present in pom.xml
**Storage**: PostgreSQL 15 — 3 new tables via Flyway V22, V23, V24; no schema changes to existing tables
**Testing**: JUnit 5, Mockito (unit), Testcontainers + Spring Boot Test (integration)
**Target Platform**: Linux server via Docker Compose (same as existing stack)
**Performance Goals**: NEWS2 < 500ms, interaction-check < 200ms, dashboard page < 1s for 100 patients
**Constraints**: Zero modifications to V1–V21 Flyway scripts; zero modifications to frozen entities; no external API calls for drug interactions; no ML for NEWS2
**Scale/Scope**: Same patient population as Module 1 (~10k patients design target)

---

## Constitution Check

*GATE: Evaluated pre-implementation. All gates PASS.*

| Principle | Status | Notes |
|---|---|---|
| Spec-Driven | PASS | Full spec in specs/006-clinical-intelligence/spec.md, approved |
| HIPAA-First | PASS | PHI never in audit logs; alert titles/descriptions use clinical context only, not PHI values; EmrAuditService reused |
| Test-First | PASS | Unit tests for all services; integration tests for all 13 endpoints; contract tests before implementation |
| Layered Architecture | PASS | Controller → Service → Repository; News2Calculator and DrugInteractionDatabase are @Component beans called from service layer |
| RBAC | PASS | RoleGuard.requireRoles() called at start of every service method; RECEPTIONIST blocked from all 13 endpoints; role scoping for DOCTOR-only dashboard |

**Complexity Justification** (non-standard elements):

| Element | Why Needed | Simpler Alternative Rejected Because |
|---|---|---|
| Native SQL in dashboard | NULLS LAST not supported in JPQL ORDER BY; cross-table COUNT aggregates cleaner in SQL | Multiple JPQL queries would cause N+1; JPQL cannot express all needed aggregates |
| Two-step dashboard (SQL + Java NEWS2) | NEWS2 algorithm must stay in Java for testability and centralization | Embedding NEWS2 logic in SQL would duplicate algorithm and make it untestable |
| Static @PostConstruct drug DB | 40+ pairs loaded once at startup; O(1) lookup | Database table: overkill for static data, adds migration burden |

---

## Project Structure

### Documentation (this feature)

```text
specs/006-clinical-intelligence/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 decisions
├── data-model.md        # Entity definitions, Flyway schema
├── quickstart.md        # Integration test scenarios
├── contracts/
│   ├── us1-lab-orders.md
│   ├── us2-news2.md
│   ├── us3-drug-interactions.md
│   ├── us4-alerts.md
│   └── us5-dashboard.md
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (backend additions)

```text
backend/src/main/java/com/ainexus/hospital/patient/
├── entity/
│   ├── LabOrder.java               # New: @Entity, UUID PK
│   ├── LabResult.java              # New: @Entity, UUID PK, 1:1 LabOrder
│   ├── ClinicalAlert.java          # New: @Entity, UUID PK
│   ├── LabOrderStatus.java         # New: enum PENDING|IN_PROGRESS|RESULTED|CANCELLED
│   ├── LabOrderPriority.java       # New: enum ROUTINE|URGENT|STAT
│   ├── LabOrderCategory.java       # New: enum 6 values
│   ├── LabResultInterpretation.java # New: enum 6 values
│   ├── AlertType.java              # New: enum 6 values
│   ├── AlertSeverity.java          # New: enum INFO|WARNING|CRITICAL
│   └── AlertStatus.java            # New: enum ACTIVE|ACKNOWLEDGED|DISMISSED
├── repository/
│   ├── LabOrderRepository.java     # New: JpaRepository<LabOrder, UUID>
│   ├── LabResultRepository.java    # New: JpaRepository<LabResult, UUID>
│   └── ClinicalAlertRepository.java # New: + findByPatientIdAndAlertTypeAndStatus()
├── service/
│   ├── LabOrderService.java        # New: createOrder, recordResult, list
│   ├── News2Service.java           # New: computeNews2(patientId)
│   ├── DrugInteractionService.java # New: checkInteractions, getInteractionSummary
│   ├── ClinicalAlertService.java   # New: createAlert (with dedup), acknowledge, dismiss, list
│   └── PatientRiskDashboardService.java # New: getRiskRankedPatients, getStats
├── controller/
│   ├── LabOrderController.java     # New: 4 endpoints
│   ├── News2Controller.java        # New: 1 endpoint
│   ├── DrugInteractionController.java # New: 2 endpoints
│   ├── ClinicalAlertController.java   # New: 4 endpoints
│   └── PatientRiskDashboardController.java # New: 2 endpoints
├── dto/
│   ├── request/
│   │   ├── CreateLabOrderRequest.java
│   │   ├── RecordLabResultRequest.java
│   │   ├── DrugInteractionCheckRequest.java
│   │   └── DismissAlertRequest.java
│   └── response/
│       ├── LabOrderResponse.java
│       ├── LabOrderSummaryResponse.java
│       ├── LabResultResponse.java
│       ├── News2Response.java
│       ├── News2ComponentScore.java
│       ├── DrugInteractionCheckResponse.java
│       ├── DrugInteractionEntry.java
│       ├── AllergyContraindication.java
│       ├── InteractionSummaryResponse.java
│       ├── ClinicalAlertResponse.java
│       ├── PatientRiskRow.java
│       ├── PatientRiskDashboardResponse.java
│       ├── DashboardStatsResponse.java
│       └── AlertTypeCount.java
├── intelligence/
│   ├── News2Calculator.java        # New: @Component, stateless algorithm
│   └── DrugInteractionDatabase.java # New: @Component, @PostConstruct loaded
└── mapper/
    ├── LabOrderMapper.java          # New: MapStruct
    ├── LabResultMapper.java         # New: MapStruct
    └── ClinicalAlertMapper.java     # New: MapStruct

backend/src/main/resources/db/migration/
├── V22__create_lab_orders.sql       # New
├── V23__create_lab_results.sql      # New
└── V24__create_clinical_alerts.sql  # New

backend/src/test/java/com/ainexus/hospital/patient/
├── unit/service/
│   ├── LabOrderServiceTest.java     # New: ~8 unit tests
│   ├── News2ServiceTest.java        # New: ~10 unit tests (NHS algorithm coverage)
│   ├── DrugInteractionServiceTest.java # New: ~8 unit tests
│   ├── ClinicalAlertServiceTest.java   # New: ~6 unit tests
│   └── PatientRiskDashboardServiceTest.java # New: ~5 unit tests
├── unit/intelligence/
│   └── News2CalculatorTest.java     # New: ~15 unit tests (all scoring branches)
└── integration/
    ├── LabOrderIT.java              # New: US1 happy path + errors
    ├── News2IT.java                 # New: US2 scoring scenarios
    ├── DrugInteractionIT.java       # New: US3 interaction + allergy
    ├── ClinicalAlertIT.java         # New: US4 feed + acknowledge + dismiss
    ├── PatientRiskDashboardIT.java  # New: US5 ranking + stats
    └── ClinicalIntelligenceRbacIT.java # New: full role matrix for all 13 endpoints
```

### Frontend additions

```text
frontend/src/
├── api/
│   ├── labOrders.js         # New: useLabOrders, useCreateLabOrder, useRecordResult
│   ├── news2.js             # New: useNews2
│   ├── drugInteractions.js  # New: useInteractionCheck, useInteractionSummary
│   ├── clinicalAlerts.js    # New: useAlerts, useAcknowledgeAlert, useDismissAlert
│   └── dashboard.js         # New: useRiskDashboard, useDashboardStats
├── pages/
│   ├── ClinicalAlertsFeedPage.jsx   # New: US4 — global alerts feed
│   └── PatientRiskDashboardPage.jsx # New: US5 — risk-ranked dashboard
└── components/
    ├── lab/
    │   ├── LabOrderForm.jsx        # New: create lab order
    │   ├── LabOrderList.jsx        # New: order list with status filter
    │   └── RecordResultForm.jsx    # New: record result modal
    ├── news2/
    │   └── News2ScoreCard.jsx      # New: score display with colour coding
    ├── alerts/
    │   ├── AlertFeed.jsx           # New: alert list with acknowledge/dismiss
    │   └── AlertBadge.jsx          # New: severity badge (CRITICAL/WARNING)
    └── dashboard/
        ├── RiskDashboardTable.jsx  # New: paginated risk-ranked table
        └── DashboardStatsCard.jsx  # New: system stats cards
```

---

## Implementation Phases

### Phase 0: Foundation (Flyway + Entities + Enums)

1. Write Flyway V22–V24 migrations
2. Implement `LabOrder`, `LabResult`, `ClinicalAlert` entities + all supporting enums
3. Implement `LabOrderRepository`, `LabResultRepository`, `ClinicalAlertRepository`
4. Implement `News2Calculator @Component` (pure algorithm, no I/O)
5. Implement `DrugInteractionDatabase @Component` (40+ pairs loaded @PostConstruct)

### Phase 1: US1 — Lab Orders & Results

1. `LabOrderService` — createOrder, recordResult (with auto-alert), listOrders, listResults
2. `LabOrderController` — 4 endpoints
3. Unit tests: `LabOrderServiceTest` (8 tests)
4. Integration tests: `LabOrderIT`

### Phase 2: US2 — NEWS2 Early Warning Score

1. `News2Service` — computeNews2 (calls News2Calculator, creates alerts via ClinicalAlertService)
2. `News2Controller` — 1 endpoint
3. Unit tests: `News2CalculatorTest` (15 tests covering all scoring branches), `News2ServiceTest`
4. Integration tests: `News2IT`

### Phase 3: US3 — Drug Interaction & Allergy Checker

1. `DrugInteractionService` — checkInteractions (drug-drug + allergy), getInteractionSummary
2. `DrugInteractionController` — 2 endpoints
3. Unit tests: `DrugInteractionServiceTest`
4. Integration tests: `DrugInteractionIT`

### Phase 4: US4 — Clinical Alerts Feed

1. `ClinicalAlertService` — createAlert (with dedup), acknowledge, dismiss, getPatientAlerts, getGlobalAlerts
2. `ClinicalAlertController` — 4 endpoints
3. Unit tests: `ClinicalAlertServiceTest`
4. Integration tests: `ClinicalAlertIT`

### Phase 5: US5 — Patient Risk Dashboard

1. `PatientRiskDashboardService` — getRiskRankedPatients (native SQL + Java NEWS2), getStats
2. `PatientRiskDashboardController` — 2 endpoints
3. Unit tests: `PatientRiskDashboardServiceTest`
4. Integration tests: `PatientRiskDashboardIT`

### Phase 6: RBAC Matrix + Frontend

1. `ClinicalIntelligenceRbacIT` — full role matrix for all 13 endpoints
2. Frontend API hooks (6 files)
3. Frontend pages and components

---

## Key Technical Decisions

1. **Alert creation in service layer**: `ClinicalAlertService.createAlert()` is called internally from `LabOrderService`, `News2Service`, and `DrugInteractionService` — all within the same `@Transactional` method. Alert is created in the same DB transaction as the triggering event, ensuring atomicity.

2. **NEWS2 in dashboard**: `PatientRiskDashboardService` runs the native SQL query for counts, then for each patient calls `VitalsRepository.findFirstByPatientIdOrderByRecordedAtDesc(patientId)` and `News2Calculator.compute(vitals)` to get the score. For typical wards (20–50 patients per page), this is acceptable. NEWS2 is not cached.

3. **Interaction checker match logic**: Drug-drug matching uses `drugName.toLowerCase().trim()` lookup in the in-memory index (exact normalized match). Allergy matching uses `allergies.stream().filter(a -> drugName.toLowerCase().contains(a.getSubstance().toLowerCase()) || a.getSubstance().toLowerCase().contains(drugName.toLowerCase()))`.

4. **Doctor-scoped filtering**: `AuthContext.Holder.get().getUserId()` returns the doctor's staff ID. The native SQL dashboard query has: `AND (:doctorId IS NULL OR p.patient_id IN (SELECT DISTINCT a.patient_id FROM appointments a WHERE a.doctor_id = :doctorId))`. ADMIN passes null.

5. **Audit**: All mutations (createOrder, recordResult, acknowledge, dismiss) call `EmrAuditService.writeAuditLog()` with entityType of `LAB_ORDER`, `LAB_RESULT`, or `CLINICAL_ALERT`. No PHI in audit log details.
